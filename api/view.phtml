<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KitePad - View</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100..900;1,100..900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/style.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/highlightjs-line-numbers.js@2.8.0/dist/highlightjs-line-numbers.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs@master/qrcode.min.js"></script>
    <style>
        /* Minimalist line numbers style */
        .hljs-ln-numbers {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            text-align: center;
            color: #444;
            border-right: 1px solid #333;
            vertical-align: top;
            padding-right: 15px !important;
        }

        .hljs-ln-code {
            padding-left: 15px !important;
        }

        .burn-notice {
            background: #3c1414;
            border: 1px solid #f00;
            padding: 10px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #ff9999;
        }

        .view-stats {
            font-size: 11px;
            color: #666;
            margin-top: 5px;
        }

        .expiration-countdown {
            font-size: 12px;
            color: #ffaa00;
            margin-top: 5px;
            font-weight: 500;
        }

        .post-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--accent);
        }

        .katex {
            font-size: 1.1em;
        }

        .embed-container {
            margin: 15px 0;
            max-width: 100%;
        }

        iframe {
            border-radius: 8px;
            border: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="nav-links">
            <a href="/" class="nav-link">Create New Paste</a>
            <a href="/view" class="nav-link">View Posts</a>
            <a href="/contact.html" class="nav-link">Contact</a>
        </div>
        <div class="header-main">
            <h1 class="title-text"><?php echo $isSingle ? "Paste Detail" : "Public Pastes"; ?></h1>
            <span class="tagline">Zero-knowledge pastebin. Configure expiry, view limit and end‑to‑end encryption in one place.</span>
        </div>

        <?php if (isset($burnMessage)): ?>
            <div class="burn-notice"><?php echo $burnMessage; ?></div>
        <?php endif; ?>

        <?php if ($isSingle && isset($hasPassword) && $hasPassword && !$passwordCorrect): ?>
            <div class="entry">
                <p>This paste is password protected.</p>
                <?php if (isset($passwordError)): ?>
                    <p style="color: #ff5555;"><?php echo $passwordError; ?></p>
                <?php endif; ?>
                <form method="POST">
                    <input type="password" name="password" class="style-input" placeholder="Enter password" required>
                    <button type="submit" class="copy-btn">Unlock</button>
                </form>
            </div>
        <?php elseif (!empty($result)): ?>
            <?php foreach ($result as $row): ?>
                <div class="entry">
                    <?php if (!empty($row['title'])): ?>
                        <div class="post-title"><?php echo htmlspecialchars($row['title']); ?></div>
                    <?php endif; ?>
                    <div class="content" id="content-<?php echo $row['id']; ?>">
                        <?php if (!empty($row['is_encrypted'])): ?>
                            <div id="decrypt-prompt-<?php echo $row['id']; ?>">
                                <p style="font-size: 14px; color: #aaa;">This content is locally encrypted (E2EE).</p>
                                <form
                                    onsubmit="handleDecrypt(event, '<?php echo $row['id']; ?>', '<?php echo htmlspecialchars($row['content']); ?>')">
                                    <input type="password" id="decrypt-pw-<?php echo $row['id']; ?>" class="style-input"
                                        placeholder="Password to decrypt" required>
                                    <button type="submit" class="copy-btn">Decrypt Content</button>
                                </form>
                            </div>
                        <?php else: ?>
                            <?php echo htmlspecialchars($row['content']); ?>
                        <?php endif; ?>
                    </div>
                    <div class="view-stats">
                        Views: <?php echo $row['view_count']; ?>
                        <?php if (isset($row['view_limit']) && $row['view_limit'] > 0): ?>
                            / Limit: <?php echo $row['view_limit']; ?>
                        <?php endif; ?>
                        <?php if (!empty($row['expires_at'])): ?>
                            <div class="expiration-countdown" data-expires="<?php echo $row['expires_at']; ?>">
                                Expires in: <span class="countdown-timer">Calculating...</span>
                            </div>
                        <?php endif; ?>
                    </div>
                    <div class="timestamp">Saved on: <?php echo $row['created_at']; ?></div>
                    <div class="actions">
                        <?php if ($isSingle): ?>
                            <button class="copy-btn" onclick="copyCurrentUrl()">Copy Link</button>
                            <button class="copy-btn" onclick="toggleQRCode()">QR Code</button>
                            <button class="copy-btn" onclick="copyContent('content-<?php echo $row['id']; ?>')">Copy
                                Content</button>
                            <div id="qrcode-wrapper" style="display: none; margin-top: 15px; padding: 15px; background: white; border-radius: 8px; width: fit-content;">
                                <div id="qrcode"></div>
                                <p style="color: #333; font-size: 11px; margin-top: 8px; text-align: center; margin-bottom: 0;">Scan to share</p>
                            </div>
                            <button class="copy-btn" onclick="location.href='/?edit=<?php echo $row['uid'] ?: $row['id']; ?>'">Edit</button>
                            <button class="copy-btn" onclick="location.href='/?clone=<?php echo $row['uid'] ?: $row['id']; ?>'">Clone</button>
                            <?php if ($hasPassword): ?>
                                <hr style="margin: 10px 0; border-top: 1px solid #222;">
                                <form method="POST" style="display: inline-block;">
                                    <input type="hidden" name="action" value="delete">
                                    <input type="password" name="password" class="style-input"
                                        style="padding: 2px 5px; font-size: 11px;" placeholder="Password to delete" required>
                                    <button type="submit" class="copy-btn" style="color: #ff5555; border-color: #331111;">Delete
                                        Post</button>
                                </form>
                            <?php endif; ?>
                        <?php else: ?>
                            <a href="/v/<?php echo $row['uid'] ?: $row['id']; ?>" class="copy-btn"
                                style="text-decoration: none; display: inline-block;">View</a>
                            <button class="copy-btn" onclick="copyShareLink('<?php echo $row['uid'] ?: $row['id']; ?>')">Copy
                                Link</button>
                            <button class="copy-btn" onclick="location.href='/?clone=<?php echo $row['uid'] ?: $row['id']; ?>'">Clone</button>
                            <button class="copy-btn" onclick="copyText(<?php echo htmlspecialchars(json_encode($row['content'])); ?>)">Copy
                                Raw</button>
                        <?php endif; ?>
                    </div>
                </div>
                <?php if ($row['content'] !== null && $row['content'] !== "[Password Protected]" && $row['content'] !== "[Burn on Read]"): ?>
                    <script>
                        (function () {
                            const isEncrypted = <?php echo !empty($row['is_encrypted']) ? 'true' : 'false'; ?>;
                            if (!isEncrypted) {
                                renderContent('<?php echo $row['id']; ?>', <?php echo json_encode($row['content'], JSON_HEX_TAG | JSON_HEX_AMP | JSON_HEX_APOS | JSON_HEX_QUOT); ?>);
                            }
                        })();
                    </script>
                <?php endif; ?>
            <?php endforeach; ?>

            <?php if (!$isSingle): ?>
                <div class="pagination">
                    <?php if ($currentPage > 1): ?>
                        <a href="/view?page=<?php echo $currentPage - 1; ?>" class="copy-btn nav-btn">Previous</a>
                    <?php else: ?>
                        <button class="copy-btn nav-btn" disabled>Previous</button>
                    <?php endif; ?>

                    <span class="page-info">Page <?php echo $currentPage; ?></span>

                    <?php if ($hasNext): ?>
                        <a href="/view?page=<?php echo $currentPage + 1; ?>" class="copy-btn nav-btn">Next</a>
                    <?php else: ?>
                        <button class="copy-btn nav-btn" disabled>Next</button>
                    <?php endif; ?>
                </div>
            <?php endif; ?>
        <?php else: ?>
            <p>No content available.</p>
        <?php endif; ?>
    </div>
    <footer class="site-footer">
        <div class="container">
            <hr>
            <p>&copy; 2026 KitePad. All rights reserved. <a href="/privacy.html" class="nav-link">Privacy
                    Policy</a>
            </p>
        </div>
    </footer>
    <script>
        // E2EE Decryption
        async function deriveKey(password, salt) {
            const encoder = new TextEncoder();
            const baseKey = await crypto.subtle.importKey(
                "raw", encoder.encode(password), "PBKDF2", false, ["deriveKey"]
            );
            return crypto.subtle.deriveKey(
                { name: "PBKDF2", salt, iterations: 100000, hash: "SHA-256" },
                baseKey, { name: "AES-GCM", length: 256 }, false, ["decrypt"]
            );
        }

        async function decryptData(base64Data, password) {
            const combined = new Uint8Array(atob(base64Data).split("").map(c => c.charCodeAt(0)));
            const salt = combined.slice(0, 16);
            const iv = combined.slice(16, 28);
            const encrypted = combined.slice(28);

            const key = await deriveKey(password, salt);
            const decrypted = await crypto.subtle.decrypt(
                { name: "AES-GCM", iv }, key, encrypted
            );
            return new TextDecoder().decode(decrypted);
        }

        async function handleDecrypt(event, id, encryptedContent) {
            event.preventDefault();
            const password = document.getElementById(`decrypt-pw-${id}`).value;
            try {
                const decrypted = await decryptData(encryptedContent, password);
                renderContent(id, decrypted);
            } catch (e) {
                alert("Decryption failed. Incorrect password?");
            }
        }

        function autoEmbed(html) {
            // Youtube
            html = html.replace(/https?:\/\/(?:www\.)?youtube\.com\/watch\?v=([a-zA-Z0-9_-]+)/g,
                '<div class="embed-container"><iframe width="100%" height="450" src="https://www.youtube.com/embed/$1" frameborder="0" allowfullscreen></iframe></div>');
            // Twitter (X) - Simple link to card if possible, but cards usually need JS. We'll at least make it look distinct or use a simple embed if available.
            // For simplicity, we'll just handle Youtube for now as Twitter embeds are heavy JS.
            return html;
        }

        function renderContent(id, content) {
            const contentDiv = document.getElementById(`content-${id}`);
            let html = marked.parse(content);
            html = autoEmbed(html);
            contentDiv.innerHTML = DOMPurify.sanitize(html);

            contentDiv.querySelectorAll('pre code').forEach((block) => {
                if (block.className.indexOf('language-') === -1) {
                    // Auto-detect language
                    const result = hljs.highlightAuto(block.innerText);
                    block.innerHTML = result.value;
                } else {
                    hljs.highlightElement(block);
                }
                hljs.lineNumbersBlock(block);
            });

            // KaTeX auto-render
            renderMathInElement(contentDiv, {
                delimiters: [
                    { left: '$$', right: '$$', display: true },
                    { left: '$', right: '$', display: false },
                    { left: '\\(', right: '\\)', display: false },
                    { left: '\\[', right: '\\]', display: true }
                ],
                throwOnError: false
            });
        }

        function copyCurrentUrl() {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => {
                alert("Link copied to clipboard!");
            });
        }

        function copyContent(elementId) {
            const element = document.getElementById(elementId);
            // Copy innerText to get the rendered text version
            navigator.clipboard.writeText(element.innerText).then(() => {
                alert("Content copied to clipboard!");
            });
        }

        function copyText(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert("Copied to clipboard!");
            });
        }

        function copyShareLink(id) {
            const shareUrl = window.location.origin + '/v/' + id;
            navigator.clipboard.writeText(shareUrl).then(() => {
                alert("Link copied to clipboard!");
            });
        }

        let qrcodeGenerated = false;
        function toggleQRCode() {
            const wrapper = document.getElementById('qrcode-wrapper');
            if (wrapper.style.display === 'none') {
                wrapper.style.display = 'block';
                if (!qrcodeGenerated) {
                    new QRCode(document.getElementById("qrcode"), {
                        text: window.location.href,
                        width: 150,
                        height: 150,
                        colorDark : "#000000",
                        colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.H
                    });
                    qrcodeGenerated = true;
                }
            } else {
                wrapper.style.display = 'none';
            }
        }

        // Countdown Timer Logic
        function updateCountdowns() {
            const elements = document.querySelectorAll('.expiration-countdown');
            elements.forEach(el => {
                const expiresAt = new Date(el.dataset.expires).getTime();
                const now = new Date().getTime();
                const diff = expiresAt - now;

                if (diff <= 0) {
                    el.innerHTML = "Expired";
                    return;
                }

                const d = Math.floor(diff / (1000 * 60 * 60 * 24));
                const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((diff % (1000 * 60)) / 1000);

                let parts = [];
                if (d > 0) parts.push(d + "d");
                if (h > 0) parts.push(h + "h");
                if (m > 0) parts.push(m + "m");
                parts.push(s + "s");

                el.querySelector('.countdown-timer').textContent = parts.join(" ");
            });
        }

        setInterval(updateCountdowns, 1000);
        updateCountdowns();
    </script>
</body>

</html>